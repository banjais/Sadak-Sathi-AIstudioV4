
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="copyright" content="Copyright (c) 2024 Your Company or Name. All Rights Reserved.">
    <title>Sadak Sathi - Your Road Companion</title>
    <!-- Replaced Leaflet with CesiumJS -->
    <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Widgets/widgets.css">
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.119/Build/Cesium/Cesium.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.16.0"
  }
}
</script>
</head>
<body>
    <!-- NEW: Redesigned Loading Overlay -->
    <div id="loading-overlay">
        <div class="loading-content">
            <div class="loading-icon-wrapper">
                <svg id="loading-icon" viewBox="0 0 100 100">
                    <circle class="compass-bg" cx="50" cy="50" r="45"/>
                    <path class="compass-needle" d="M 50,15 L 60,50 L 50,85 L 40,50 Z" />
                </svg>
            </div>
            <p id="loading-message" data-lang-key="loading_initializing">Initializing...</p>
        </div>
    </div>

    <div id="app-container" data-theme="light" data-mode="driving">
        <div id="map"></div>
        
        <!-- App Header -->
        <header id="app-header">
            <div class="header-left">
                <div class="app-title">
                    <h1>Sadak Sathi</h1>
                    <p class="app-subtitle" data-lang-key="app_subtitle">Your Smart Road Companion</p>
                </div>
                <div id="gps-status-indicator" title="GPS Status: Searching..."></div>
                <p id="gps-status-text" data-lang-key="gps_searching" class="hidden">GPS Status: Searching...</p>
            </div>
            <div class="header-right">
                <button id="live-cam-btn" class="icon-button" title="Live Cam">
                    <span class="material-icons">videocam</span>
                </button>
                 <button id="theme-toggle" class="icon-button" data-lang-key-aria-label="toggle_dark_mode" title="Toggle dark mode">
                    <span class="material-icons">light_mode</span>
                </button>
                <div id="language-selector-container">
                    <button id="language-selector-btn" aria-haspopup="true" aria-expanded="false">
                        <span class="material-icons colorful-globe">language</span>
                        <span id="current-lang-label">English</span>
                        <span class="material-icons">arrow_drop_down</span>
                    </button>
                    <div id="language-popup" class="hidden" role="menu">
                        <div class="lang-category open">
                            <button class="lang-category-header" aria-expanded="true">
                                <span data-lang-key="lang_cat_national">National</span>
                                <span class="material-icons expand-icon">expand_more</span>
                            </button>
                            <div class="lang-options-list">
                                <button class="lang-option" role="menuitem" data-lang="np">ðŸ‡³ðŸ‡µ Nepali</button>
                                <button class="lang-option" role="menuitem" data-lang="new">ðŸ‡³ðŸ‡µ Newar</button>
                                <button class="lang-option" role="menuitem" data-lang="mth">ðŸ‡³ðŸ‡µ Maithili</button>
                                <button class="lang-option" role="menuitem" data-lang="bjp">ðŸ‡³ðŸ‡µ Bhojpuri</button>
                                <button class="lang-option" role="menuitem" data-lang="th">ðŸ‡³ðŸ‡µ Tharu</button>
                                <button class="lang-option" role="menuitem" data-lang="tm">ðŸ‡³ðŸ‡µ Tamang</button>
                                <button class="lang-option" role="menuitem" data-lang="mg">ðŸ‡³ðŸ‡µ Magar</button>
                                <button class="lang-option" role="menuitem" data-lang="dot">ðŸ‡³ðŸ‡µ Doteli</button>
                            </div>
                        </div>
                        <div class="lang-category">
                            <button class="lang-category-header" aria-expanded="false">
                                <span data-lang-key="lang_cat_international">International</span>
                                <span class="material-icons expand-icon">chevron_right</span>
                            </button>
                            <div class="lang-options-list">
                                <button class="lang-option active" role="menuitem" data-lang="en">ðŸ‡¬ðŸ‡§ English</button>
                                <button class="lang-option" role="menuitem" data-lang="es">ðŸ‡ªðŸ‡¸ Spanish</button>
                                <button class="lang-option" role="menuitem" data-lang="fr">ðŸ‡«ðŸ‡· French</button>
                                <button class="lang-option" role="menuitem" data-lang="de">ðŸ‡©ðŸ‡ª German</button>
                                <button class="lang-option" role="menuitem" data-lang="it">ðŸ‡®ðŸ‡¹ Italian</button>
                                <button class="lang-option" role="menuitem" data-lang="zh">ðŸ‡¨ðŸ‡³ Chinese</button>
                                <button class="lang-option" role="menuitem" data-lang="ja">ðŸ‡¯ðŸ‡µ Japanese</button>
                                <button class="lang-option" role="menuitem" data-lang="ko">ðŸ‡°ðŸ‡· Korean</button>
                                <button class="lang-option" role="menuitem" data-lang="ar">ðŸ‡¸ðŸ‡¦ Arabic</button>
                                <button class="lang-option" role="menuitem" data-lang="ru">ðŸ‡·ðŸ‡º Russian</button>
                                <button class="lang-option" role="menuitem" data-lang="hi">ðŸ‡®ðŸ‡³ Hindi</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Proactive Alert Banner -->
        <div id="proactive-alert" class="hidden">
            <span class="material-icons alert-icon">campaign</span>
            <p id="alert-message"></p>
            <div class="alert-actions">
                <button id="alert-ask-ai-btn" class="alert-btn" data-lang-key="alert_ask_ai">Ask AI</button>
                <button id="alert-close-btn" class="icon-button" data-lang-key-aria-label="alert_dismiss">
                    <span class="material-icons">close</span>
                </button>
            </div>
        </div>
        
        <!-- Map Overlays (Controls) -->
        <div id="map-overlays-top-right">
            <div id="map-controls-container">
                <button id="zoom-in-btn" class="map-control-button" title="Zoom In"><span class="material-icons">add</span></button>
                <button id="zoom-out-btn" class="map-control-button" title="Zoom Out"><span class="material-icons">remove</span></button>
                <button id="center-location-btn" class="map-control-button" data-lang-key-title="center_location"><span class="material-icons">my_location</span></button>
                <button id="travel-time-btn" class="map-control-button" title="Travel Time Map"><span class="material-icons">timer</span></button>
                <div id="map-options-selector">
                    <button id="map-options-btn" class="map-control-button" title="Map Options"><span class="material-icons">layers</span></button>
                    <div id="map-options-popup" class="hidden">
                         <div class="map-options-section">
                            <h4 data-lang-key="layers">Data Layers</h4>
                            <div class="layer-toggle">
                                <label for="toggle-roads" data-lang-key="roads">Roads</label>
                                <input type="checkbox" id="toggle-roads" class="toggle-switch" checked>
                            </div>
                            <div class="layer-toggle">
                                <label for="toggle-pois" data-lang-key="pois">Points of Interest</label>
                                <input type="checkbox" id="toggle-pois" class="toggle-switch" checked>
                            </div>
                            <div class="layer-toggle">
                                <label for="toggle-incidents" data-lang-key="incidents">Live Alerts</label>
                                <input type="checkbox" id="toggle-incidents" class="toggle-switch" checked>
                            </div>
                             <div class="layer-toggle">
                                <label for="toggle-3d" data-lang-key="buildings_3d">3D Buildings/Terrain</label>
                                <input type="checkbox" id="toggle-3d" class="toggle-switch" checked>
                            </div>
                        </div>
                        <hr>
                        <div class="map-options-section">
                            <h4>Map Styles</h4>
                            <div class="style-options-grid">
                                <button class="style-option active" data-style="streets" data-lang-key="map_style_streets">Streets</button>
                                <button class="style-option" data-style="satellite" data-lang-key="map_style_satellite">Satellite</button>
                                <button class="style-option" data-style="dark" data-lang-key="map_style_dark">Dark</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: Unified Search Container -->
        <div id="unified-search-container">
            <!-- UPDATED: New Search Bar Layout -->
            <div id="unified-search-bar">
                <div class="text-search-group">
                    <input type="text" id="unified-search-input" placeholder="Search for a place or ask AI...">
                    <button id="unified-search-action-btn" class="icon-button" title="Search">
                        <span class="material-icons">search</span>
                    </button>
                </div>
                <div class="search-separator"></div>
                <div class="other-methods-group">
                    <button id="unified-search-voice-btn" class="icon-button" title="Voice Search">
                        <span class="material-icons">mic</span>
                    </button>
                    <button id="map-pin-btn" class="icon-button" title="Choose on Map">
                        <span class="material-icons">place</span>
                    </button>
                    <button id="unified-search-ai-btn" class="icon-button" title="Ask AI">
                        <img id="unified-search-ai-avatar" src="https://i.imgur.com/r33W56s.png" alt="AI Persona">
                    </button>
                </div>
            </div>
            <div id="search-suggestions-panel" class="hidden">
                <!-- Suggestions will be populated here -->
            </div>
             <!-- This section will be shown when actively routing -->
            <div id="active-routing-panel" class="hidden">
                <div class="route-inputs">
                     <div class="input-group">
                        <div class="input-wrapper">
                             <span class="material-icons input-icon">trip_origin</span>
                            <input type="text" id="from-input" data-lang-key-placeholder="from_placeholder">
                        </div>
                    </div>
                     <div class="swap-locations-container">
                        <button id="swap-locations-btn" class="icon-button" data-lang-key-aria-label="swap_locations" title="Swap Locations">
                            <span class="material-icons">swap_vert</span>
                        </button>
                    </div>
                    <div class="input-group">
                        <div class="input-wrapper">
                            <span class="material-icons input-icon">flag</span>
                            <input type="text" id="to-input" data-lang-key-placeholder="to_placeholder">
                        </div>
                    </div>
                </div>
                 <div class="route-actions">
                    <button id="find-route-btn" class="primary-btn"><span class="material-icons">directions</span></button>
                    <button id="clear-route-btn" class="secondary-btn"><span class="material-icons">close</span></button>
                </div>
            </div>
        </div>
        
        <!-- NEW: Map Pin Selection UI -->
        <div id="map-pin-marker" class="hidden">
            <span class="material-icons">place</span>
        </div>
        <div id="map-pin-selection-ui" class="hidden">
            <p>Move the map to your desired location</p>
            <button id="confirm-pin-location-btn" class="primary-btn">Confirm Location</button>
            <button id="cancel-pin-location-btn" class="icon-button"><span class="material-icons">close</span></button>
        </div>

        <!-- NEW: Travel Time Panel -->
        <div id="travel-time-panel" class="hidden">
            <div class="panel-header">
                <h2>Travel Time Map</h2>
                <button id="travel-time-close-btn" class="icon-button"><span class="material-icons">close</span></button>
            </div>
            <div class="panel-content">
                <div class="setting-item-col">
                    <label for="travel-time-origin-input">Starting Point</label>
                    <div class="input-wrapper">
                         <span class="material-icons input-icon">trip_origin</span>
                        <input type="text" id="travel-time-origin-input" placeholder="Choose a starting point...">
                    </div>
                     <div class="origin-options">
                        <button id="travel-time-use-current-loc" class="secondary-btn">Use Current Location</button>
                        <button id="travel-time-pick-on-map" class="secondary-btn">Pick on Map</button>
                    </div>
                </div>
                <div class="setting-item-col">
                    <label>Travel Time Intervals (minutes)</label>
                    <div class="checkbox-group">
                        <div><input type="checkbox" id="tt-15" value="15" checked><label for="tt-15">15</label></div>
                        <div><input type="checkbox" id="tt-30" value="30" checked><label for="tt-30">30</label></div>
                        <div><input type="checkbox" id="tt-45" value="45"><label for="tt-45">45</label></div>
                        <div><input type="checkbox" id="tt-60" value="60"><label for="tt-60">60</label></div>
                    </div>
                </div>
                <div class="disclaimer">
                    <span class="material-icons">info</span>
                    <p>Estimates are based on straight-line distance ("as the crow flies") and an average speed, not actual road networks.</p>
                </div>
                <div class="panel-actions">
                    <button id="generate-travel-time-map-btn" class="primary-btn">Generate Map</button>
                    <button id="clear-travel-time-map-btn" class="secondary-btn">Clear</button>
                </div>
            </div>
        </div>

        <!-- NEW: Travel Time Legend -->
        <div id="travel-time-legend" class="hidden">
            <h4>Travel Time</h4>
            <ul>
                <li><span class="legend-color" style="background-color: rgba(46, 204, 113, 0.5);"></span>15 min</li>
                <li><span class="legend-color" style="background-color: rgba(241, 196, 15, 0.5);"></span>30 min</li>
                <li><span class="legend-color" style="background-color: rgba(230, 126, 34, 0.5);"></span>45 min</li>
                <li><span class="legend-color" style="background-color: rgba(231, 76, 60, 0.5);"></span>60 min</li>
            </ul>
        </div>


        <!-- Live Camera Panel -->
        <div id="live-cam-panel" class="hidden">
            <div id="live-cam-header">
                 <span class="material-icons cam-status-icon">sensors</span>
                 <span class="cam-title">Live Cam</span>
                 <div class="cam-controls">
                    <button id="toggle-cam-analysis-btn" class="icon-button" title="Toggle AI Analysis"><span class="material-icons">visibility_off</span></button>
                    <button id="flip-cam-btn" class="icon-button" title="Flip Camera"><span class="material-icons">flip_camera_android</span></button>
                    <button id="close-cam-btn" class="icon-button" title="Close Camera"><span class="material-icons">close</span></button>
                 </div>
            </div>
            <div class="live-cam-body">
                <video id="live-cam-video" autoplay playsinline class="hidden"></video>
                <img id="ip-cam-stream" class="hidden" alt="IP Camera Stream"/>
                <canvas id="live-cam-overlay"></canvas>
                <div id="live-cam-placeholder">
                    <span class="material-icons">no_photography</span>
                    <p>Camera Unavailable</p>
                </div>
            </div>
        </div>
        
        <!-- Side Display Panel -->
        <div id="display-panel" class="collapsed">
            <div id="display-panel-header" class="panel-header">
                <h2 data-lang-key="display_panel_title">Nearby Information</h2>
                <div class="panel-header-controls">
                    <span class="material-icons panel-toggle-icon">expand_less</span>
                </div>
            </div>
            <div id="display-panel-content">
                <div id="display-panel-filters"></div>
                <div id="display-panel-list">
                    <p data-lang-key="no_items_found">No items found.</p>
                </div>
            </div>
        </div>

        <!-- Route Details Panel -->
        <div id="route-details-panel" class="hidden">
            <div id="route-loading-overlay" class="hidden">
                <div class="spinner"></div>
                <p data-lang-key="finding_best_routes">Finding the best routes for you...</p>
            </div>
             <div class="panel-header">
                <h2 data-lang-key="route_details">Route Details</h2>
                <button id="route-details-close" class="icon-button" data-lang-key-aria-label="close">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="route-summary">
                <div class="route-stat">
                    <span class="stat-label" data-lang-key="route_details_distance">Distance</span>
                    <span class="stat-value" id="route-distance">-- km</span>
                </div>
                <div class="route-stat">
                    <span class="stat-label" data-lang-key="route_details_time">Est. Time</span>
                    <span class="stat-value" id="route-time">-- min</span>
                </div>
                 <div class="route-stat">
                    <span class="stat-label">Road Status</span>
                    <span class="stat-value" id="route-overall-status">--</span>
                </div>
            </div>
            <!-- NEW: Alternative Routes Container -->
            <div id="route-alternatives-container" class="hidden">
                <h4>Alternative Routes</h4>
                <div id="route-alternatives">
                    <!-- Alternative route cards will be populated here by JS -->
                </div>
            </div>
            <div id="route-preferences-summary" class="hidden">
                <h4 data-lang-key="route_prefs_used">Route Preferences Used:</h4>
                <ul id="route-preferences-list"></ul>
            </div>
            <div class="directions-container">
                 <h3 id="route-directions-title" data-lang-key="route_details_directions">Directions</h3>
                 <div id="route-directions-list"></div>
            </div>
            <div class="route-details-actions">
                 <button id="share-route-btn" class="secondary-btn icon-only" data-lang-key-aria-label="share_route"><span class="material-icons">share</span></button>
                 <button id="view-gmaps-btn" class="secondary-btn icon-only" data-lang-key-aria-label="view_on_gmaps"><span class="material-icons">map</span></button>
                 <button id="start-navigation-btn" class="primary-btn">
                    <span class="material-icons">navigation</span>
                    <span data-lang-key="start_navigation">Start Navigation</span>
                </button>
            </div>
        </div>
        
        <!-- Settings Panel (Off-canvas) -->
        <aside id="settings-panel">
            <div class="panel-header">
                <h2 data-lang-key="app_settings">App Settings</h2>
                <button class="icon-button" onclick="document.getElementById('settings-panel').classList.remove('open')" data-lang-key-aria-label="close">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="settings-content">
                 <div class="settings-section">
                    <h3 data-lang-key="ai_persona_title">AI Persona</h3>
                     <div class="persona-avatar-uploader">
                        <label for="persona-avatar-upload" data-lang-key-title="change_ai_avatar">
                            <img id="persona-avatar-preview" src="https://i.imgur.com/r33W56s.png" alt="AI Avatar">
                            <div class="upload-icon"><span class="material-icons">edit</span></div>
                        </label>
                        <input type="file" id="persona-avatar-upload" accept="image/png, image/jpeg, image/svg+xml" class="hidden">
                    </div>
                    <div class="setting-item-col">
                        <label for="persona-personality-select" data-lang-key="ai_personality_label">Personality</label>
                        <select id="persona-personality-select">
                            <option value="friendly" data-lang-key="personality_friendly">Friendly</option>
                            <option value="formal" data-lang-key="personality_formal">Formal</option>
                            <option value="guide" data-lang-key="personality_guide">Travel Guide</option>
                            <option value="buddy" data-lang-key="personality_buddy">Driver's Buddy</option>
                        </select>
                        <p id="persona-personality-description" class="setting-description"></p>
                    </div>
                    <div class="setting-item-col">
                        <label for="persona-relationship-select" data-lang-key="ai_relationship_label">Relationship</label>
                        <select id="persona-relationship-select">
                            <option value="friend" data-lang-key="relationship_friend">Friend</option>
                            <option value="partner" data-lang-key="relationship_partner">Partner</option>
                            <option value="husband" data-lang-key="relationship_husband">Husband</option>
                            <option value="wife" data-lang-key="relationship_wife">Wife</option>
                        </select>
                    </div>
                    <div class="setting-item-col">
                        <label for="persona-voice-select" data-lang-key="ai_voice_label">Voice</label>
                        <select id="persona-voice-select">
                            <option value="female" data-lang-key="voice_female">Female</option>
                            <option value="male" data-lang-key="voice_male">Male</option>
                            <option value="neutral" data-lang-key="voice_neutral">Neutral</option>
                        </select>
                    </div>
                 </div>
                 <div class="settings-section">
                    <h3 data-lang-key="preferences_title">Preferences</h3>
                    <div class="setting-item">
                        <label for="toggle-voice-response" data-lang-key="ai_voice_response">AI Voice Response</label>
                        <input type="checkbox" id="toggle-voice-response" class="toggle-switch" checked>
                    </div>
                 </div>
                 <div class="settings-section">
                     <h3 data-lang-key="route_preferences">Route Preferences</h3>
                     <div class="setting-item">
                        <label for="pref-highways" data-lang-key="prefer_highways">Prefer Highways</label>
                        <input type="checkbox" id="pref-highways" class="toggle-switch">
                    </div>
                     <div class="setting-item">
                        <label for="pref-no-tolls" data-lang-key="avoid_tolls">Avoid Tolls</label>
                        <input type="checkbox" id="pref-no-tolls" class="toggle-switch">
                    </div>
                     <div class="setting-item">
                        <label for="pref-scenic" data-lang-key="prefer_scenic_route">Prefer Scenic Route</label>
                        <input type="checkbox" id="pref-scenic" class="toggle-switch">
                    </div>
                 </div>
            </div>
        </aside>

        <!-- Modals -->
        <div id="ai-chat-modal" class="hidden">
            <div class="chat-panel">
                <div class="panel-header chat-header">
                    <img id="chat-ai-avatar" src="https://i.imgur.com/r33W56s.png" alt="AI Avatar" class="ai-avatar">
                    <div class="ai-info">
                        <h2 id="chat-ai-name">Sadak Sathi</h2>
                        <span class="ai-status">Online</span>
                    </div>
                    <button id="close-chat-btn" class="icon-button" data-lang-key-aria-label="close_chat">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div class="chat-messages">
                    <!-- Messages will be added here -->
                </div>
                 <div id="language-switch-proposal" class="hidden">
                    <p id="language-proposal-text"></p>
                    <div class="proposal-actions">
                        <button id="confirm-lang-switch" class="proposal-btn">Yes</button>
                        <button id="decline-lang-switch" class="proposal-btn">No</button>
                    </div>
                </div>
                <div class="typing-indicator hidden"><span></span><span></span><span></span></div>
                <div class="chat-input-area">
                     <button id="context-chat-btn" class="hidden" data-lang-key="ask_about_location">Ask about this location</button>
                    <form id="chat-form">
                        <button type="button" id="voice-command-btn" class="icon-button" data-lang-key-aria-label="use_microphone" title="Use Microphone">
                            <span class="material-icons">mic</span>
                        </button>
                        <input type="text" id="chat-input" data-lang-key-placeholder="ai_chat_placeholder" autocomplete="off">
                        <button type="submit" class="icon-button" data-lang-key-aria-label="send_message" title="Send Message">
                            <span class="material-icons">send</span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div id="route-options-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3 data-lang-key="route_options_title">Route Options</h3>
                <button class="modal-close-btn icon-button" data-lang-key-aria-label="close"><span class="material-icons">close</span></button>
                <div id="route-options-list"></div>
            </div>
        </div>
        
        <div id="app-mode-modal" class="modal-overlay hidden">
            <div class="modal-content">
                 <h3 data-lang-key="select_mode">Select Mode</h3>
                 <button class="modal-close-btn icon-button" data-lang-key-aria-label="close"><span class="material-icons">close</span></button>
                 <div class="mode-selection">
                    <button class="mode-select-btn" data-mode="driving">
                        <span class="material-icons">directions_car</span>
                        <span data-lang-key="mode_driving">Driving</span>
                    </button>
                     <button class="mode-select-btn" data-mode="riding">
                        <span class="material-icons">two_wheeler</span>
                        <span data-lang-key="mode_riding">Riding</span>
                    </button>
                     <button class="mode-select-btn" data-mode="exploring">
                        <span class="material-icons">explore</span>
                        <span data-lang-key="mode_exploring">Exploring</span>
                    </button>
                     <button class="mode-select-btn" data-mode="connect">
                        <span class="material-icons">hub</span>
                        <span data-lang-key="mode_connect">Connect</span>
                    </button>
                 </div>
            </div>
        </div>

        <div id="profile-modal" class="modal-overlay hidden">
             <div class="modal-content">
                <button class="modal-close-btn icon-button" data-lang-key-aria-label="close"><span class="material-icons">close</span></button>

                <!-- Login View -->
                <div id="login-view">
                     <h3>Welcome Back!</h3>
                     <p class="modal-subtitle">Log in to sync your preferences.</p>
                     <form id="login-form">
                        <input type="email" id="login-email" placeholder="Enter your email" required>
                        <button type="submit" class="primary-btn">Send OTP</button>
                     </form>
                     <div id="login-error-message" class="error-message hidden"></div>
                </div>

                <!-- OTP View -->
                <div id="otp-view" class="hidden">
                    <h3>Verify Your Identity</h3>
                    <p class="modal-subtitle">An OTP has been sent to <b id="otp-email-display"></b>.</p>
                     <form id="otp-form">
                        <input type="text" id="otp-input" placeholder="123456" pattern="\d{6}" required>
                        <button type="submit" class="primary-btn">Log In</button>
                     </form>
                    <div id="otp-error-message" class="error-message hidden"></div>
                </div>

                <!-- Profile View -->
                <div id="profile-view" class="hidden">
                    <div class="profile-header">
                        <img id="profile-avatar" src="https://i.imgur.com/r33W56s.png" alt="User Avatar">
                        <div class="profile-info">
                            <span id="profile-email">user@example.com</span>
                            <span id="profile-role-badge" data-role="user">user</span>
                        </div>
                    </div>
                    <div class="profile-actions">
                         <button id="open-settings-btn" class="secondary-btn">
                             <span class="material-icons">settings</span>
                             <span data-lang-key="app_settings">App Settings</span>
                         </button>
                         <button id="admin-panel-btn" class="secondary-btn hidden">
                             <span class="material-icons">admin_panel_settings</span>
                             <span>Admin Panel</span>
                         </button>
                         <button id="logout-btn" class="danger-btn">
                             <span class="material-icons">logout</span>
                             <span>Log Out</span>
                         </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="admin-panel-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3>Superadmin Panel</h3>
                <button class="modal-close-btn icon-button" data-lang-key-aria-label="close"><span class="material-icons">close</span></button>
                <div class="admin-config-section">
                     <div class="setting-item-col">
                        <label for="admin-road-data-url">Road Status Data URL</label>
                        <input type="text" id="admin-road-data-url" disabled>
                        <div class="secure-notice">
                             <span class="material-icons">lock</span>
                             <span>This is managed by the DoRS and cannot be changed here.</span>
                        </div>
                    </div>
                    <div class="setting-item-col">
                        <label for="admin-traffic-data-url">Live Traffic Data URL (Future)</label>
                        <input type="text" id="admin-traffic-data-url" disabled>
                    </div>
                    <div class="setting-item-col">
                        <label for="admin-ip-cam-url">IP Camera Stream URL</label>
                        <input type="text" id="admin-ip-cam-url" placeholder="e.g., http://192.168.1.100/stream">
                        <button id="save-ip-cam-btn" class="primary-btn" style="margin-top: 0.5rem;">Save & Close</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="report-incident-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="panel-header" style="padding: 0 0 1.5rem 0;">
                    <h3 data-lang-key="report_incident_title">Report New Road Incident</h3>
                    <button id="report-incident-close" class="modal-close-btn icon-button" data-lang-key-aria-label="close">
                        <span class="material-icons">close</span>
                    </button>
                </div>
                <div id="report-incident-content">
                    <div id="report-location-unavailable" class="hidden">
                        <p data-lang-key="report_location_unavailable">Your current location is not available. Please enable GPS to report an incident.</p>
                    </div>
                    <form id="report-incident-form">
                        <div class="setting-item-col" style="margin-bottom: 1rem;">
                            <label for="incident-location" data-lang-key="location">Location</label>
                            <div class="input-wrapper">
                                <span class="material-icons input-icon">my_location</span>
                                <input type="text" id="incident-location" disabled data-lang-key-placeholder="current_location">
                            </div>
                        </div>
                        <div class="setting-item-col" style="margin-bottom: 1rem;">
                            <label for="incident-type" data-lang-key="incident_type">Type of Incident</label>
                            <select id="incident-type" required>
                                <option value="Accident" data-lang-key="incident_type_accident">Accident</option>
                                <option value="Roadblock" data-lang-key="incident_type_roadblock">Roadblock</option>
                                <option value="Construction" data-lang-key="incident_type_construction">Construction</option>
                                <option value="Hazard" data-lang-key="incident_type_hazard">Hazard</option>
                                <option value="Traffic Jam" data-lang-key="incident_type_traffic">Traffic Jam</option>
                                <option value="Other" data-lang-key="incident_type_other">Other</option>
                            </select>
                        </div>
                        <div class="setting-item-col" style="margin-bottom: 1rem;">
                            <label for="incident-description" data-lang-key="description">Description (Optional)</label>
                            <textarea id="incident-description" rows="3" data-lang-key-placeholder="incident_desc_placeholder"></textarea>
                        </div>

                        <!-- NEW: Image Refinement Section -->
                        <div class="setting-item-col" style="margin-bottom: 1rem;">
                            <label for="incident-image-upload">Attach Photo &amp; Refine with AI (Optional)</label>
                            <input type="file" id="incident-image-upload" accept="image/png, image/jpeg, image/webp">
                        </div>
            
                        <div id="image-refinement-area" class="hidden">
                            <div class="image-preview-container">
                                <img id="incident-image-preview" src="#" alt="Incident Preview">
                                <div id="refinement-loader" class="hidden">
                                    <div class="spinner"></div>
                                </div>
                            </div>
                            <div class="setting-item-col">
                                <label for="refinement-prompt">Refinement Prompt</label>
                                <div class="input-wrapper">
                                    <span class="material-icons input-icon">auto_awesome</span>
                                    <input type="text" id="refinement-prompt" placeholder="e.g., 'circle the pothole in red'">
                                </div>
                            </div>
                            <button type="button" id="refine-image-btn" class="secondary-btn" style="width: 100%; margin-top: 0.5rem;">Refine with AI</button>
                        </div>
                        <!-- End Image Refinement Section -->

                        <button type="submit" class="primary-btn" style="width: 100%; margin-top: 1.5rem;" data-lang-key="submit_report">Submit Report</button>
                    </form>
                </div>
            </div>
        </div>

        <!-- NEW: Find My Car Modal -->
        <div id="find-car-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <div class="panel-header" style="padding: 0 0 1.5rem 0;">
                    <h3 data-lang-key="find_my_car_modal_title">Find My Car</h3>
                    <button id="find-car-close-btn" class="modal-close-btn icon-button"><span class="material-icons">close</span></button>
                </div>
                <div id="find-car-content">
                    <div id="no-car-location-view">
                        <p data-lang-key="car_location_not_saved">You haven't saved your car's location yet.</p>
                        <button id="park-here-btn" class="primary-btn">
                            <span class="material-icons">local_parking</span>
                            <span data-lang-key="park_here">Park Here</span>
                        </button>
                    </div>
                    <div id="car-location-saved-view" class="hidden">
                        <p data-lang-key="car_location_saved_at">Your car is parked at:</p>
                        <strong id="saved-car-address" data-lang-key="fetching_address">Fetching address...</strong>
                        <div class="car-location-actions">
                            <button id="get-directions-to-car-btn" class="primary-btn">
                                <span class="material-icons">directions</span>
                                <span data-lang-key="get_directions">Get Directions</span>
                            </button>
                            <button id="clear-car-location-btn" class="secondary-btn">
                                <span class="material-icons">delete</span>
                                <span data-lang-key="clear_location">Clear Location</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEW: Permission Help Modal -->
        <div id="permission-help-modal" class="modal-overlay hidden">
            <div class="modal-content">
                <button id="permission-modal-close-btn" class="modal-close-btn icon-button" data-lang-key-aria-label="close"><span class="material-icons">close</span></button>
                <h3>Microphone Access Denied</h3>
                <p>To use voice commands, you need to allow microphone access in your browser's address bar.</p>
                <div class="permission-animation">
                    <svg viewBox="0 0 300 80" class="permission-svg">
                        <!-- Address Bar -->
                        <rect x="10" y="10" width="280" height="40" rx="5" fill="#f1f3f4"/>
                        <circle cx="25" cy="30" r="5" fill="#ed6a5e"/>
                        <circle cx="45" cy="30" r="5" fill="#f4be4f"/>
                        <circle cx="65" cy="30" r="5" fill="#61c554"/>
                        
                        <!-- Lock Icon -->
                        <g id="lock-icon" transform="translate(80 22)">
                            <rect x="2" y="5" width="12" height="9" rx="1" fill="#5f6368"/>
                            <path d="M4,5 V3 C4,1.34 5.34,0 7,0 h2 c1.66,0 3,1.34 3,3 v2" stroke="#5f6368" stroke-width="2" fill="none"/>
                        </g>
                        
                        <!-- Text -->
                        <text x="105" y="35" font-family="sans-serif" font-size="14" fill="#3c4043">sadak-sathi.app</text>
                        
                        <!-- Hand Cursor -->
                        <g id="hand-cursor" transform="translate(85, 40)">
                             <path d="M6.51,25.74,7.86,12.39a1.5,1.5,0,0,0-3,0L3.49,25.74" fill="#f4c57c" stroke="#5c4a3a" stroke-linecap="round" stroke-linejoin="round"/>
                             <path d="M12.51,25.74,13.86,12.39a1.5,1.5,0,0,0-3,0L9.49,25.74" fill="#f4c57c" stroke="#5c4a3a" stroke-linecap="round" stroke-linejoin="round"/>
                             <path d="M18.51,25.74,19.86,12.39a1.5,1.5,0,0,0-3,0L15.49,25.74" fill="#f4c57c" stroke="#5c4a3a" stroke-linecap="round" stroke-linejoin="round"/>
                             <path d="M24.51,25.74,25.86,12.39a1.5,1.5,0,0,0-3,0L21.49,25.74" fill="#f4c57c" stroke="#5c4a3a" stroke-linecap="round" stroke-linejoin="round"/>
                             <path d="M4.6,18.15a2,2,0,0,0-2.3-1.63,2,2,0,0,0-1.63,2.3l2.3,6.9a2,2,0,0,0,2.3,1.63,2,2,0,0,0,1.63-2.3Z" fill="#f4c57c" stroke="#5c4a3a" stroke-linecap="round" stroke-linejoin="round"/>
                        </g>
                    </svg>
                </div>
            </div>
        </div>


        <!-- Toast Notification -->
        <div id="toast-notification" class="hidden" role="alert">
            <span id="toast-icon" class="material-icons">info</span>
            <p id="toast-message"></p>
        </div>
        
        <!-- Report Incident FAB -->
        <button id="report-incident-fab" class="icon-button" data-lang-key-title="report_incident_title">
            <span class="material-icons">add_alert</span>
        </button>

        <!-- NEW: FAB Menu (Replaces Bottom Menu) -->
        <div id="fab-container">
            <div id="fab-menu-items" class="hidden">
                <button id="fab-find-car-btn" class="fab-menu-item" data-lang-key-title="find_my_car_title">
                    <span class="material-icons">directions_car</span>
                </button>
                <button id="fab-ai-btn" class="fab-menu-item" data-lang-key-title="ai_chat_title">
                    <span class="material-icons">auto_awesome</span>
                </button>
                <button id="fab-settings-btn" class="fab-menu-item" data-lang-key-title="app_settings">
                    <span class="material-icons">settings</span>
                </button>
                <button id="fab-profile-btn" class="fab-menu-item" data-lang-key-title="profile">
                    <span class="material-icons">person</span>
                </button>
            </div>
            <button id="fab-main-btn" class="fab-main" data-lang-key-aria-label="main_menu">
                <span class="material-icons">menu</span>
            </button>
        </div>

        <!-- NEW: Smart Detail Card -->
        <div id="detail-card">
            <div class="detail-card-header">
                <h3 id="detail-card-title"></h3>
                <button id="detail-card-close" class="icon-button">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <!-- NEW: Weather Section (Moved) -->
            <div id="detail-card-weather" class="hidden">
                <img id="weather-icon" src="" alt="Weather icon">
                <span id="weather-temp"></span>
                <span id="weather-desc"></span>
            </div>
            <div id="detail-card-content">
                <!-- Content injected by JS -->
            </div>
            <div id="detail-card-actions">
                <!-- Action buttons injected by JS -->
            </div>
        </div>


    </div>
    <script type="module" src="index.js"></script>
</body>
</html>
